import React, { useState } from 'react';
import Head from 'next/head'
import dynamic from 'next/dynamic';
import { Container, Box, Link, Button, Typography } from '@mui/material';
import { visuallyHidden } from '@mui/utils';
import MarkChatUnreadIcon from '@mui/icons-material/MarkChatUnread';
import {
  BannerText,
  PageTitle,
  PageDescribe,
  EipsSearchWrap,
} from '@/components/eip-style';
import EmailSubscribe from '@/components/EmailSubscribe';
import { formatMeta, formatComEIP } from '@/utils/str';
import { readFile, } from 'node:fs/promises';

export default function EIPDetails({ children, meta, id, jsxData }) {
  const [show, setShow] = useState(false);
  const handleShow = () => {
    setShow((state) => !state);
  };
  const EIPDetail = dynamic(() => import(`@/original-eips/eips/${id}.md`));

return (<>

  <Head>
    <title>{meta.title}</title>
     <meta property="og:title" content={meta.title} key="title" />
     <meta property="og:description" content={meta.abstract || meta.description} key="description" />
  </Head>
  <Box borderTop={1} borderColor="#EAEBF0" />
  <Container maxWidth="lg">
    <Box py={4}>
      EIPs &gt;{' '}
      <Link
      sx={{  textDecoration: 'none' }}
      href="#" >
        EIPs {meta.eip}
      </Link>
    </Box>

    <Box sx={{position: 'relative', background: "#333 url('/images/eip_details_bg.png') no-repeat top left"}} height="310px" borderRadius={1}>
      <Box sx={{position: 'absolute', color: '#fff', fontSize: '80px' }} right={50} bottom={56}>
        ERC {meta.eip}
      </Box>
    </Box>

    <Box sx={{fontSize: '40px', fontWeight: 'bold', lineHeight: '48px'}} pt={4}>{meta.title}</Box>

    {(meta.abstract || meta.description) && (
      <Box pt={2} sx={{lineHeight: '24px', color: '#5F6D7E'}}>{meta.abstract || meta.description}</Box>
    )}

    <Box pb={4} pt={2}>
      <span style={{display: 'inline-block', lineHeight: '20px', padding: '0 8px', background: '#FFFAE9', color: '#FFC700', fontSize: '14px', borderRadius: '5px', marginRight: '16px'}}>{meta.status}</span>
      <span style={{display: 'inline-block', lineHeight: '20px', padding: '0 8px', background: '#F5FAFF', color: '#437EF7', fontSize: '14px', borderRadius: '5px',}}> Standards track - ERC</span>
    </Box>

    <Box pb={4} sx={{fontSize: '14px', fontWeight: 'bold'}}>
      Created: <span style={{fontWeight: 'normal'}}>{meta.created}</span>
      {meta['last-call-deadline'] ? (
        <>
          Last Call Deadline: <span>{meta['last-call-deadline']}</span>
        </>
      ) : null}
    </Box>

    {meta.requires && meta.requires > 0 && (
      <Box pb="4">
        Requires: <Link sx={{ textDecoration: 'none' }}>EIP-{meta.requires}</Link>
      </Box>
    )}

    <Box pb={4}>
      {meta?.author?.includes(', ')
        ? meta.author.split(', ').map((item) => item + ', ')
        : meta.author}
      {/* Vitalik Buterin (<Link sx={{textDecoration: 'none'}}>@vbuterin</Link>),  Yoav Weiss(<Link sx={{textDecoration: 'none'}}>@@yoavw</Link>),  Kristof Gazso (<Link sx={{textDecoration: 'none'}}>@kristofgazso</Link>), Namra Patel (<Link sx={{textDecoration: 'none'}}>@namrapatel</Link>), Dror Tirosh (<Link sx={{textDecoration: 'none'}}>@drortirosh</Link>), Shahaf Nacson (<Link sx={{textDecoration: 'none'}}>@shahafn</Link>), Tjaden Hess (<Link sx={{textDecoration: 'none'}}>@tjade273</Link>) */}
    </Box>

    <Box pt={4} pb={3}>
      {meta['discussions-to'] && (
        <Button
          sx={{marginRight: '16px'}}
          variant="contained"
          startIcon={<MarkChatUnreadIcon />}
          size="large"
          href={meta['discussions-to']}
        >
          Discussions
        </Button>
      )}

      <Button
        variant="outlined"
        size="large"
        href={`https://eips.ethereum.org/EIPS/eip-${meta.eip}`}
      >
        Original link
      </Button>
    </Box>

    <Box sx={{ display: 'flex' }}>
      <Box sx={{ width: '840px' }} mr={3}>
        <Box
          sx={{
            lineHeight: '30px',
            fontSize: '22px',
            fontWeight: '500',
            paddingBottom: '24px',
          }}
        >
          1 min read{' '}
          <b
            style={{
              fontSize: '14px',
              color: '#5F6D7E',
              fontWeight: 'normal',
            }}
          >
            by chatGPT-4
          </b>
        </Box>

        <Box
          sx={{
            padding: '24px 32px 38px',
            border: '1px solid #F5F5F5',
            borderRadius: '6px',
          }}
        >
          <h3 style={{ lineHeight: '20px', paddingBottom: '20px' }}>
            <span
              style={{
                color: '#437EF7',
                fontSize: '14px',
                padding: '0 12px',
                background: '#F5FAFF',
              }}
            >
              By ChatGPT-4
            </span>
          </h3>
          <div
            style={{
              lineHeight: '24px',
              color: '#5F6D7E',
            }}
          >
            {meta.chatgpt4}
          </div>
        </Box>

        <Box
          sx={{
            lineHeight: '30px',
            fontSize: '22px',
            fontWeight: '600',
            color: '#272d37',
            padding: '48px 0 24px',
          }}
        >
          Original
        </Box>

        <Box
          sx={{
            position: 'relative',
            padding: '24px 32px 38px',
          }}
          border={1}
          borderColor="#f5f5f5"
          borderRadius={1.5}
          mb={6}
        >
          <Box sx={[{ height: show ? 'auto' : '526px', overflow: 'hidden', '& h2': { display: 'none'} } ]}>
            <Box sx={visuallyHidden}>{jsxData}</Box>
            <EIPDetail />
          </Box>
          <Box sx={{ marginTop: '30px', textAlign: 'center' }}>
            <Button variant="contained" onClick={handleShow}>
              {show ? 'Put away' : 'View More'}
            </Button>
          </Box>
        </Box>

        {meta['extended resources']?.length > 0 && (<>
          <Box
          sx={{
            lineHeight: '30px',
            fontSize: '22px',
            fontWeight: '500',
            paddingBottom: '24px',
          }}
        >
          Quick read {' '}
          <b style={{ fontSize: '14px', color: '#5F6D7E', fontWeight: 'normal' }}>
            by Analyst
          </b>
        </Box>

        <Box sx={{display: 'flex'}}>
          {meta['extended resources'].map(item => (<Box sx={{width: '404px', marginBottom: '52px'}} mr={4}>
            <div style={{height: '84px', borderRadius: '6px'}}>
              <img style={{display: 'block', width: '100%', height: '100%', border: 'none'}} src={item.imgSrc} alt={item.alt} />
            </div>
            <div style={{fontSize: '18px', lineHeight: '30px', fontWeight: '600', padding: '16px 0'}}>{item.title}</div>
            <div> <Link href={item.link} sx={{textDecoration: 'none'}}>Learn more â†’</Link></div>
          </Box>))}
        </Box></>)}
      </Box>

        {meta.projects?.length > 0 && <><Box sx={{flex: 1}}>
          <Box sx={{height: 'auto', padding: '24px 24px 0', border: '1px solid #eaebf0', borderRadius: '10px'}}>
            <h3 style={{paddingBottom: '24px', fontSize: '18px', lineHeight: '28px'}}>Adopted by projects</h3>

            {meta.projects.map(item => (<>
              <Box sx={{height: '100px', background: '#f3f3f3'}}>
                <img style={{display: 'block', width: '100%', height: '100%', border: 'none'}} src={item.imgSrc} alt={item.alt} />
              </Box>
              <Box sx={{fontSize: '16px', lineHeight: '30px', color: '#272d37', padding: '16px 0'}}>{item.title}</Box>
            </>))}
          </Box>
        </Box></>}
    </Box>

    <EipsSearchWrap>
      <EmailSubscribe />
    </EipsSearchWrap>

  </Container>
</>);
}

export async function getServerSideProps(context) {
  let id = context.params.id;
  let originalEIP;
  try {
    originalEIP = await readFile(`./original-eips/eips/${id}.md`, 'utf8');
  } catch (e) {
    console.log(e);
  }
  let meta, con;
  if (originalEIP) {
    [, meta, ...con] = originalEIP.split('---');
  }
  meta = formatMeta(meta);
  try {
    let comEIP = await readFile(`./eips/en/${id}.md`, 'utf8');
    Object.assign(meta, formatComEIP(comEIP));
  } catch (e) {
    console.log(e);
  }
  return {
    props: {
      meta,
      jsxData: con.toString(),
      id: id,
    },
  };
}
